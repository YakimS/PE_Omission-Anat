---
title: "R Notebook"
output: html_notebook
#tutorial: https://bodowinter.com/tutorial/bw_LME_tutorial2.pdf
#youtube: https://www.youtube.com/watch?v=u1ePV1ntMNs&t=297s&ab_channel=LiquidBrainBioinformatics
---

```{r}
library(lmerTest)
library(Matrix)
library(bayestestR)
library(dplyr)

curr_ver = "10_1_OE6OR6_sleep_withoutN3N1"

o_sepRF <- read.csv("C:\\Users\\User\\Cloud-Drive\\BigFiles\\OmissionExpOutput\\mix_modeling\\mm_10_1_sub-ses-100msTimeWin_traits_negOR6OE6Clust_withsleep.csv")
output_dir <- "C:\\Users\\User\\Cloud-Drive\\BigFiles\\OmissionExpOutput\\mix_modeling"
# head(omissionResponse)
# tail(omissionResponse)
# str(omissionResponse)
# colnames(omissionResponse)
# summary(omissionResponse)
# which(is.na(omissionResponse$ampAvg)) # or which(!complete.cases(politeness))

```


```{r}
o_sepRF <- subset(o_sepRF, ses != "")
o_sepRF <- subset(o_sepRF, block_type != "0")
o_sepRF <- subset(o_sepRF, sleep_stage != "N3")
o_sepRF <- subset(o_sepRF, sleep_stage != "N1")
# Change values to "REM"
o_sepRF$sleep_stage <- ifelse(o_sepRF$sleep_stage %in% c("Rt", "Rp"), "REM", o_sepRF$sleep_stage)
o_sepRF$sub <- as.factor(o_sepRF$sub)
o_sepRF$block_type <- as.factor(o_sepRF$block_type)
o_sepRF$sleep_stage <- as.factor(o_sepRF$sleep_stage)


o_sepRF$timeWin <- as.factor(o_sepRF$timeWin)
o_sepRF$opos <- as.ordered(o_sepRF$opos)
o_sepRF$seniority <- as.ordered(o_sepRF$seniority)
o_sepRF$blockpos <- as.ordered(o_sepRF$blockpos)

str(o_sepRF)

# Numeric (continuous): Real numbers.
# Factor (categorical): Unordered categorical variables.
# Ordered factor (ordinal): Ordered categorical variables.
# Binary (logical): Binary values, often coded as 0/1.
# Integer: Whole numbers.
```

```{r}
posneg_vector = c('neg')
sleep_stage_vars <- unique(o_sepRF$sleep_stage)
timeWin_vars <- unique(o_sepRF$timeWin)
block_type_vars <- unique(o_sepRF$block_type)
```


```{r}
# Combinations of fixed variables, vs. null 
# Within timeWin & sleep_stage_vars

filename = paste("mm_", curr_ver,"_res_sepRF_allFixed+1sub_within-TimewinSleepstage_interOnly.csv", sep = "")

fixed_vars= c( "blockpos", "block_type","seniority")

# all posible combinations
all_models_fix_var <- unlist(sapply(1:length(fixed_vars), function(x) combn(fixed_vars, x, paste, collapse = "+")))

# create res table
res_table <- data.frame('elect_clust' = character(), 'timewin' = character(),'sleep_stage' = character(),"fixed_vars" = character(), "BF" = numeric(), "anova_Pval_Chisq" = list())
for (var_name in fixed_vars) {
  res_table[[var_name]] <-  numeric()
}

for (mod in all_models_fix_var) {
  for (posneg in posneg_vector) {
    for (j in timeWin_vars) {
      for (i in sleep_stage_vars) {
        exp_mod <- paste("ampAvg_", posneg ," ~ 1 + ",mod," + (1|sub)", sep = "")
        null_mod <- paste("ampAvg_",posneg ," ~ 1 + (1|sub)", sep = "")
        o_sepRF.model<-lmer(as.formula(exp_mod) , data=subset(o_sepRF, timeWin == j & sleep_stage==i ), REML=FALSE)
        o_sepRF.null <- lmer(as.formula(null_mod) , data=subset(o_sepRF, timeWin == j & sleep_stage==i ), REML=FALSE)
        
        anova_preTerm_out = anova(o_sepRF.model)
        anova_out = anova(o_sepRF.null,o_sepRF.model)
        bayes_out <- bayesfactor_models(o_sepRF.model,denominator=o_sepRF.null)
        
        res_table <- add_row(res_table)
        row_num = nrow(res_table)
        res_table[row_num, "elect_clust"] <- posneg
        res_table[row_num, "timewin"] <- j
        res_table[row_num, "sleep_stage"] <- i
        res_table[row_num, "fixed_vars"] <- mod[[1]]
        res_table[row_num, "BF"] <- exp(bayes_out$log_BF[1])
        res_table[row_num, "anova_Pval_Chisq"] <- anova_out$"Pr(>Chisq)"[2]
        
        for (i in 1:nrow(anova_preTerm_out)) {
          row_name <- rownames(anova_preTerm_out)[i]
          row_value <- anova_preTerm_out[i,"Pr(>F)"]
          res_table[row_num, row_name] <- row_value
        }
      }
    }
  }
}

sortedTable <- res_table[order(res_table$BF, decreasing = TRUE), ]
sortedTable <- sortedTable[, c('elect_clust','timewin' ,'sleep_stage',"fixed_vars", 'BF', 'anova_Pval_Chisq',  names(sortedTable)[-2])]
write.csv(sortedTable, paste0(output_dir,"\\",paste(filename)))
print(sortedTable)

```

```{r}
# Combinations of fixed variables, vs. null 
# Within sleep_stage_vars

filename = paste("mm_", curr_ver,"_res_sepRF_allFixed+1sub+trialID_within-sleepstage_interOnly.csv", sep = "")

fixed_vars= c( "timeWin","blockpos", "block_type","seniority")

# all posible combinations
all_models_fix_var <- unlist(sapply(1:length(fixed_vars), function(x) combn(fixed_vars, x, paste, collapse = "+")))

# create res table
res_table <- data.frame('elect_clust' = character(),'sleep_stage' = character(),"fixed_vars" = character(), "BF" = numeric(), "anova_Pval_Chisq" = list())
for (var_name in fixed_vars) {
  res_table[[var_name]] <-  numeric()
}

for (mod in all_models_fix_var) {
  for (posneg in posneg_vector) {
    for (i in sleep_stage_vars) {
      exp_mod <- paste("ampAvg_", posneg ," ~ 1 + ",mod," + (1|sub) + (1|trialID)", sep = "")
      null_mod <- paste("ampAvg_",posneg ," ~ 1 + (1|sub) + (1|trialID)", sep = "")
      o_sepRF.model<-lmer(as.formula(exp_mod) , data=subset(o_sepRF, sleep_stage==i ), REML=FALSE)
      o_sepRF.null <- lmer(as.formula(null_mod) , data=subset(o_sepRF, sleep_stage==i ), REML=FALSE)
      
      anova_preTerm_out = anova(o_sepRF.model)
      anova_out = anova(o_sepRF.null,o_sepRF.model)
      bayes_out <- bayesfactor_models(o_sepRF.model,denominator=o_sepRF.null)
      
      res_table <- add_row(res_table)
      row_num = nrow(res_table)
      res_table[row_num, "elect_clust"] <- posneg
      res_table[row_num, "sleep_stage"] <- i
      res_table[row_num, "fixed_vars"] <- mod[[1]]
      res_table[row_num, "BF"] <- exp(bayes_out$log_BF[1])
      res_table[row_num, "anova_Pval_Chisq"] <- anova_out$"Pr(>Chisq)"[2]
      
      for (i in 1:nrow(anova_preTerm_out)) {
        row_name <- rownames(anova_preTerm_out)[i]
        row_value <- anova_preTerm_out[i,"Pr(>F)"]
        res_table[row_num, row_name] <- row_value
      }
    }
  }
}

sortedTable <- res_table[order(res_table$BF, decreasing = TRUE), ]
sortedTable <- sortedTable[, c('elect_clust','sleep_stage',"fixed_vars", 'BF', 'anova_Pval_Chisq',  names(sortedTable)[-2])]
write.csv(sortedTable, paste0(output_dir,"\\",paste(filename)))
print(sortedTable)

```

```{r}
# Combinations of fixed variables, vs. null 
# Within timeWin

filename = paste("mm_", curr_ver,"_res_sepRF_allFixed+1sub_within-Timewin_interOnly.csv", sep = "")

fixed_vars= c( "blockpos", "block_type","seniority",'sleep_stage')

# all posible combinations
all_models_fix_var <- unlist(sapply(1:length(fixed_vars), function(x) combn(fixed_vars, x, paste, collapse = "+")))

# create res table
res_table <- data.frame('elect_clust' = character(), 'timewin' = character(),"fixed_vars" = character(), "BF" = numeric(), "anova_Pval_Chisq" = list())
for (var_name in fixed_vars) {
  res_table[[var_name]] <-  numeric()
}

for (mod in all_models_fix_var) {
  for (posneg in posneg_vector) {
    for (j in timeWin_vars) {
      exp_mod <- paste("ampAvg_", posneg ," ~ 1 + ",mod," + (1|sub)", sep = "")
      null_mod <- paste("ampAvg_",posneg ," ~ 1 + (1|sub)", sep = "")
      o_sepRF.model<-lmer(as.formula(exp_mod) , data=subset(o_sepRF, timeWin == j  ), REML=FALSE)
      o_sepRF.null <- lmer(as.formula(null_mod) , data=subset(o_sepRF, timeWin == j ), REML=FALSE)
      
      anova_preTerm_out = anova(o_sepRF.model)
      anova_out = anova(o_sepRF.null,o_sepRF.model)
      bayes_out <- bayesfactor_models(o_sepRF.model,denominator=o_sepRF.null)
      
      res_table <- add_row(res_table)
      row_num = nrow(res_table)
      res_table[row_num, "elect_clust"] <- posneg
      res_table[row_num, "timewin"] <- j
      res_table[row_num, "fixed_vars"] <- mod[[1]]
      res_table[row_num, "BF"] <- exp(bayes_out$log_BF[1])
      res_table[row_num, "anova_Pval_Chisq"] <- anova_out$"Pr(>Chisq)"[2]
      
      for (i in 1:nrow(anova_preTerm_out)) {
        row_name <- rownames(anova_preTerm_out)[i]
        row_value <- anova_preTerm_out[i,"Pr(>F)"]
        res_table[row_num, row_name] <- row_value
      }
    }
  }
}

sortedTable <- res_table[order(res_table$BF, decreasing = TRUE), ]
sortedTable <- sortedTable[, c('elect_clust','timewin',"fixed_vars", 'BF', 'anova_Pval_Chisq',  names(sortedTable)[-2])]
write.csv(sortedTable, paste0(output_dir,"\\",paste(filename)))
print(sortedTable)

```


```{r}
# Combinations of fixed variables, vs. null 
# Within ALL

fixed_vars= c( "blockpos", "timeWin", "block_type","seniority","sleep_stage")
filename = paste("mm_", curr_ver,"_res_sepRF_allFixed+1sub+1trialID_within-X_interOnly.csv", sep = "")

# all posible combinations
all_models_fix_var <- unlist(sapply(1:length(fixed_vars), function(x) combn(fixed_vars, x, paste, collapse = "+")))

# create res table
res_table <- data.frame('elect_clust' = character(), "fixed_vars" = character(), "BF" = numeric(), "anova_Pval_Chisq" = list())
for (var_name in fixed_vars) {
  res_table[[var_name]] <-  numeric()
}

for (mod in all_models_fix_var) {
  for (posneg in posneg_vector) {
    exp_mod <- paste("ampAvg_", posneg ," ~ 1 + ",mod," + (1|sub) + (1|trialID)", sep = "")
    null_mod <- paste("ampAvg_",posneg ," ~ 1 + (1|sub) + (1|trialID)", sep = "")
    o_sepRF.model<-lmer(as.formula(exp_mod) , data=subset(o_sepRF), REML=FALSE)
    o_sepRF.null <- lmer(as.formula(null_mod) , data=subset(o_sepRF), REML=FALSE)
    
    
    anova_preTerm_out = anova(o_sepRF.model)
    anova_out = anova(o_sepRF.null,o_sepRF.model)
    bayes_out <- bayesfactor_models(o_sepRF.model,denominator=o_sepRF.null)
    
    res_table <- add_row(res_table)
    row_num = nrow(res_table)
    res_table[row_num, "elect_clust"] <- posneg
    res_table[row_num, "fixed_vars"] <- mod[[1]]
    res_table[row_num, "BF"] <- exp(bayes_out$log_BF[1])
    res_table[row_num, "anova_Pval_Chisq"] <- anova_out$"Pr(>Chisq)"[2]
    
    for (i in 1:nrow(anova_preTerm_out)) {
      row_name <- rownames(anova_preTerm_out)[i]
      row_value <- anova_preTerm_out[i,"Pr(>F)"]
      res_table[row_num, row_name] <- row_value
    }
  }
}

sortedTable <- res_table[order(res_table$BF, decreasing = TRUE), ]
sortedTable <- sortedTable[, c('elect_clust',"fixed_vars", 'BF', 'anova_Pval_Chisq',  names(sortedTable)[-2])]
write.csv(sortedTable, paste0(output_dir,"\\",paste(filename)))
print(sortedTable)

```
